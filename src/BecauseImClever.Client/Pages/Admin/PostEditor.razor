@page "/admin/posts/new"
@page "/admin/posts/edit/{Slug}"
@using BecauseImClever.Application.Interfaces
@using BecauseImClever.Domain.Entities
@using System.Net.Http.Json
@layout AdminLayout
@attribute [Authorize(Policy = "Admin")]
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Admin - @(IsEditMode ? "Edit Post" : "New Post")</PageTitle>

<div class="post-editor">
    <div class="editor-header">
        <h1>@(IsEditMode ? "Edit Post" : "Create New Post")</h1>
        <p class="editor-subtitle">@(IsEditMode ? $"Editing: {originalTitle}" : "Write a new blog post")</p>
    </div>

    @if (errorMessage is not null)
    {
        <div class="alert alert-error">
            <span>@errorMessage</span>
            <button class="alert-close" @onclick="() => errorMessage = null">&times;</button>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading-indicator">
            <span>@(IsEditMode ? "Loading post..." : "Preparing editor...")</span>
        </div>
    }
    else
    {
        <EditForm Model="@formModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="form-grid">
                <!-- Left Column: Main Content -->
                <div class="form-main">
                    <!-- Title -->
                    <div class="form-group">
                        <label for="title">Title <span class="required">*</span></label>
                        <InputText id="title" @bind-Value="formModel.Title" placeholder="Enter post title..." @oninput="OnTitleChanged" />
                        <ValidationMessage For="() => formModel.Title" />
                    </div>

                    <!-- Slug -->
                    <div class="form-group">
                        <label for="slug">
                            Slug <span class="required">*</span>
                            @if (!IsEditMode)
                            {
                                <button type="button" class="btn-link" @onclick="GenerateSlug">Generate from title</button>
                            }
                        </label>
                        <InputText id="slug" @bind-Value="formModel.Slug" placeholder="url-friendly-slug" disabled="@IsEditMode" />
                        <span class="form-hint">URL: /posts/@formModel.Slug</span>
                        <ValidationMessage For="() => formModel.Slug" />
                    </div>

                    <!-- Summary -->
                    <div class="form-group">
                        <label for="summary">Summary <span class="required">*</span></label>
                        <InputTextArea id="summary" @bind-Value="formModel.Summary" rows="3" placeholder="Brief description of the post..." />
                        <ValidationMessage For="() => formModel.Summary" />
                    </div>

                    <!-- Content -->
                    <div class="form-group form-group-content">
                        <label>Content (Markdown) <span class="required">*</span></label>
                        <MarkdownEditor @bind-Value="formModel.Content"
                                        @bind-IsPreviewOnly="isPreviewOnly"
                                        Placeholder="Write your post in Markdown..." />
                        <ValidationMessage For="() => formModel.Content" />
                    </div>
                </div>

                <!-- Right Column: Metadata -->
                <div class="form-sidebar">
                    <!-- Actions Card -->
                    <div class="sidebar-card">
                        <h3>Actions</h3>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <span>@(IsEditMode ? "Update Post" : "Create Post")</span>
                                }
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                            @if (IsEditMode)
                            {
                                <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                            }
                        </div>
                    </div>

                    <!-- Status Card -->
                    <div class="sidebar-card">
                        <h3>Status</h3>
                        <div class="form-group">
                            <InputSelect @bind-Value="formModel.Status">
                                <option value="@PostStatus.Draft">Draft</option>
                                <option value="@PostStatus.Published">Published</option>
                                <option value="@PostStatus.Debug">Debug</option>
                            </InputSelect>
                        </div>
                    </div>

                    <!-- Published Date Card -->
                    <div class="sidebar-card">
                        <h3>Published Date</h3>
                        <div class="form-group">
                            <InputDate @bind-Value="formModel.PublishedDate" />
                        </div>
                    </div>

                    <!-- Tags Card -->
                    <div class="sidebar-card">
                        <h3>Tags</h3>
                        <div class="form-group">
                            <InputText @bind-Value="formModel.TagsInput" placeholder="tag1, tag2, tag3" />
                            <span class="form-hint">Comma-separated list of tags</span>
                        </div>
                        <div class="tags-preview">
                            @foreach (var tag in GetTags())
                            {
                                <span class="tag">@tag</span>
                            }
                        </div>
                    </div>

                    @if (IsEditMode)
                    {
                        <!-- Metadata Card -->
                        <div class="sidebar-card">
                            <h3>Metadata</h3>
                            <div class="metadata-info">
                                <div class="metadata-row">
                                    <span class="metadata-label">Created:</span>
                                    <span>@formModel.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                                @if (!string.IsNullOrEmpty(formModel.CreatedBy))
                                {
                                    <div class="metadata-row">
                                        <span class="metadata-label">By:</span>
                                        <span>@formModel.CreatedBy</span>
                                    </div>
                                }
                                <div class="metadata-row">
                                    <span class="metadata-label">Updated:</span>
                                    <span>@formModel.UpdatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                                @if (!string.IsNullOrEmpty(formModel.UpdatedBy))
                                {
                                    <div class="metadata-row">
                                        <span class="metadata-label">By:</span>
                                        <span>@formModel.UpdatedBy</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </EditForm>
    }
</div>

@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-content" @onclick:stopPropagation>
            <h3>Delete Post</h3>
            <p>Are you sure you want to delete "<strong>@originalTitle</strong>"?</p>
            <p class="warning-text">This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-danger" @onclick="DeletePost" disabled="@isDeleting">
                    @(isDeleting ? "Deleting..." : "Yes, Delete")
                </button>
                <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .post-editor {
        max-width: 1400px;
        margin: 0 auto;
    }

    .editor-header {
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1rem;
    }

    .editor-header h1 {
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
    }

    .editor-subtitle {
        color: var(--text-muted);
        margin: 0;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 2rem;
    }

    .form-main {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .sidebar-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
    }

    .sidebar-card h3 {
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 500;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .required {
        color: #f44336;
    }

    .btn-link {
        background: none;
        border: none;
        color: var(--accent-color);
        font-size: 0.8rem;
        cursor: pointer;
        padding: 0;
        margin-left: auto;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .form-group input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .form-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .form-group-content {
        flex: 1;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, opacity 0.2s;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-primary {
        background: var(--accent-color);
        color: var(--bg-color);
    }

    .btn-primary:hover:not(:disabled) {
        filter: brightness(1.1);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover:not(:disabled) {
        background: var(--bg-color);
    }

    .btn-danger {
        background: #f44336;
        color: white;
    }

    .btn-danger:hover:not(:disabled) {
        background: #d32f2f;
    }

    .tags-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tag {
        background: var(--accent-color);
        color: var(--bg-color);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .metadata-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .metadata-row {
        display: flex;
        gap: 0.5rem;
    }

    .metadata-label {
        color: var(--text-muted);
        min-width: 60px;
    }

    .alert {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .alert-error {
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        color: #f44336;
    }

    .alert-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
    }

    .alert-close:hover {
        opacity: 1;
    }

    .loading-indicator {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
    }

    .modal-content h3 {
        margin: 0 0 1rem 0;
        color: var(--text-color);
    }

    .modal-content p {
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }

    .warning-text {
        color: #f44336;
        font-size: 0.9rem;
    }

    .modal-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .validation-message {
        color: #f44336;
        font-size: 0.85rem;
    }

    @@media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-sidebar {
            order: -1;
        }
    }
</style>

@code {
    [Parameter]
    public string? Slug { get; set; }

    private PostEditorModel formModel = new();
    private string? originalTitle;
    private bool isLoading = true;
    private bool isSaving;
    private bool isDeleting;
    private bool showDeleteConfirm;
    private bool isPreviewOnly;
    private string? errorMessage;

    private bool IsEditMode => !string.IsNullOrEmpty(Slug);

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await LoadPost();
        }
        else
        {
            formModel.PublishedDate = DateTime.Today;
            formModel.Status = PostStatus.Draft;
            isLoading = false;
        }
    }

    private async Task LoadPost()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var post = await Http.GetFromJsonAsync<PostForEdit>($"api/admin/posts/{Slug}");
            if (post != null)
            {
                formModel = new PostEditorModel
                {
                    Title = post.Title,
                    Slug = post.Slug,
                    Summary = post.Summary,
                    Content = post.Content,
                    PublishedDate = post.PublishedDate.LocalDateTime,
                    Status = post.Status,
                    TagsInput = string.Join(", ", post.Tags),
                    CreatedAt = post.CreatedAt,
                    UpdatedAt = post.UpdatedAt,
                    CreatedBy = post.CreatedBy,
                    UpdatedBy = post.UpdatedBy,
                };
                originalTitle = post.Title;
            }
            else
            {
                errorMessage = "Post not found.";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to load post: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnTitleChanged(ChangeEventArgs e)
    {
        formModel.Title = e.Value?.ToString() ?? string.Empty;
        if (!IsEditMode && string.IsNullOrEmpty(formModel.Slug))
        {
            GenerateSlug();
        }
    }

    private void GenerateSlug()
    {
        if (string.IsNullOrWhiteSpace(formModel.Title))
        {
            return;
        }

        formModel.Slug = formModel.Title
            .ToLowerInvariant()
            .Replace(" ", "-")
            .Replace("--", "-")
            .Trim('-');

        // Remove special characters except hyphens
        formModel.Slug = new string(formModel.Slug
            .Where(c => char.IsLetterOrDigit(c) || c == '-')
            .ToArray());
    }

    private IEnumerable<string> GetTags()
    {
        if (string.IsNullOrWhiteSpace(formModel.TagsInput))
        {
            return Enumerable.Empty<string>();
        }

        return formModel.TagsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(t => t.Trim())
            .Where(t => !string.IsNullOrWhiteSpace(t));
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(formModel.Title) ||
            string.IsNullOrWhiteSpace(formModel.Slug) ||
            string.IsNullOrWhiteSpace(formModel.Summary) ||
            string.IsNullOrWhiteSpace(formModel.Content))
        {
            errorMessage = "Please fill in all required fields.";
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            var tags = GetTags().ToList();
            var publishedDate = new DateTimeOffset(formModel.PublishedDate, TimeSpan.Zero);

            if (IsEditMode)
            {
                var request = new UpdatePostRequest(
                    formModel.Title,
                    formModel.Summary,
                    formModel.Content,
                    publishedDate,
                    formModel.Status,
                    tags);

                var response = await Http.PutAsJsonAsync($"api/admin/posts/{Slug}", request);

                if (response.IsSuccessStatusCode)
                {
                    Navigation.NavigateTo("/admin/posts");
                }
                else
                {
                    var result = await response.Content.ReadFromJsonAsync<UpdatePostResult>();
                    errorMessage = result?.Error ?? "Failed to update post.";
                }
            }
            else
            {
                var request = new CreatePostRequest(
                    formModel.Title,
                    formModel.Slug,
                    formModel.Summary,
                    formModel.Content,
                    publishedDate,
                    formModel.Status,
                    tags);

                var response = await Http.PostAsJsonAsync("api/admin/posts", request);

                if (response.IsSuccessStatusCode)
                {
                    Navigation.NavigateTo("/admin/posts");
                }
                else
                {
                    var result = await response.Content.ReadFromJsonAsync<CreatePostResult>();
                    errorMessage = result?.Error ?? "Failed to create post.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/posts");
    }

    private void ConfirmDelete()
    {
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
    }

    private async Task DeletePost()
    {
        isDeleting = true;
        errorMessage = null;

        try
        {
            var response = await Http.DeleteAsync($"api/admin/posts/{Slug}");

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/admin/posts");
            }
            else
            {
                var result = await response.Content.ReadFromJsonAsync<DeletePostResult>();
                errorMessage = result?.Error ?? "Failed to delete post.";
                showDeleteConfirm = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            showDeleteConfirm = false;
        }
        finally
        {
            isDeleting = false;
        }
    }

    private class PostEditorModel
    {
        public string Title { get; set; } = string.Empty;
        public string Slug { get; set; } = string.Empty;
        public string Summary { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public DateTime PublishedDate { get; set; } = DateTime.Today;
        public PostStatus Status { get; set; } = PostStatus.Draft;
        public string TagsInput { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
        public string? CreatedBy { get; set; }
        public string? UpdatedBy { get; set; }
    }
}
