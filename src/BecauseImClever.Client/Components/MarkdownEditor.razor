@using Markdig
@inject IJSRuntime JS

<div class="markdown-editor @(IsPreviewOnly ? "preview-only" : "split-view")">
    <!-- Toolbar -->
    @if (!IsPreviewOnly)
    {
        <div class="editor-toolbar">
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn" title="Bold (Ctrl+B)" @onclick="() => InsertFormatting(FormattingType.Bold)">
                    <span class="toolbar-icon">B</span>
                </button>
                <button type="button" class="toolbar-btn" title="Italic (Ctrl+I)" @onclick="() => InsertFormatting(FormattingType.Italic)">
                    <span class="toolbar-icon italic">I</span>
                </button>
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn" title="Heading 1 (Ctrl+1)" @onclick="() => InsertFormatting(FormattingType.H1)">
                    H1
                </button>
                <button type="button" class="toolbar-btn" title="Heading 2 (Ctrl+2)" @onclick="() => InsertFormatting(FormattingType.H2)">
                    H2
                </button>
                <button type="button" class="toolbar-btn" title="Heading 3 (Ctrl+3)" @onclick="() => InsertFormatting(FormattingType.H3)">
                    H3
                </button>
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn" title="Link (Ctrl+K)" @onclick="() => InsertFormatting(FormattingType.Link)">
                    üîó
                </button>
                <button type="button" class="toolbar-btn" title="Image (Ctrl+Shift+I)" @onclick="() => InsertFormatting(FormattingType.Image)">
                    üñºÔ∏è
                </button>
                @if (!string.IsNullOrEmpty(PostSlug))
                {
                    <button type="button" class="toolbar-btn toolbar-btn-upload" title="Upload Image" @onclick="OpenImageUploadDialog">
                        üì§
                    </button>
                }
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn" title="Inline Code (Ctrl+`)" @onclick="() => InsertFormatting(FormattingType.InlineCode)">
                    <code>&lt;/&gt;</code>
                </button>
                <button type="button" class="toolbar-btn" title="Code Block (Ctrl+Shift+`)" @onclick="() => InsertFormatting(FormattingType.CodeBlock)">
                    <span class="code-block-icon">{ }</span>
                </button>
            </div>
            <div class="toolbar-separator"></div>
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn" title="Quote (Ctrl+Q)" @onclick="() => InsertFormatting(FormattingType.Quote)">
                    ‚ùù
                </button>
                <button type="button" class="toolbar-btn" title="Bulleted List (Ctrl+U)" @onclick="() => InsertFormatting(FormattingType.BulletList)">
                    ‚Ä¢
                </button>
                <button type="button" class="toolbar-btn" title="Numbered List (Ctrl+O)" @onclick="() => InsertFormatting(FormattingType.NumberedList)">
                    1.
                </button>
            </div>
            <div class="toolbar-spacer"></div>
            <div class="toolbar-group">
                <button type="button" class="toolbar-btn @(IsPreviewOnly ? "active" : "")" title="Toggle Preview" @onclick="TogglePreview">
                    üëÅÔ∏è
                </button>
            </div>
        </div>
    }

    <div class="editor-content">
        <!-- Editor Pane -->
        @if (!IsPreviewOnly)
        {
            <div class="editor-pane">
                <textarea id="@TextAreaId"
                          class="editor-textarea"
                          value="@Value"
                          @oninput="OnValueChanged"
                          @onkeydown="HandleKeyDown"
                          placeholder="@Placeholder"
                          spellcheck="true"></textarea>
            </div>
        }

        <!-- Preview Pane -->
        <div class="preview-pane @(IsPreviewOnly ? "full-width" : "")">
            <div class="preview-header">
                <span>Preview</span>
                @if (IsPreviewOnly)
                {
                    <button type="button" class="btn-link" @onclick="TogglePreview">‚Üê Back to Editor</button>
                }
            </div>
            <div id="@PreviewPaneId" class="preview-content markdown-body">
                @((MarkupString)RenderedHtml)
            </div>
        </div>
    </div>
</div>

@if (showImageUploadDialog)
{
    <ImageUploadDialog PostSlug="@PostSlug"
                       OnImageInserted="HandleImageInserted"
                       OnClose="CloseImageUploadDialog" />
}

<style>
    .markdown-editor {
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-color);
    }

    .editor-toolbar {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
    }

    .toolbar-group {
        display: flex;
        gap: 0.125rem;
    }

    .toolbar-separator {
        width: 1px;
        height: 24px;
        background: var(--border-color);
        margin: 0 0.25rem;
    }

    .toolbar-spacer {
        flex: 1;
    }

    .toolbar-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        padding: 0;
        border: none;
        border-radius: 4px;
        background: transparent;
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.15s;
    }

    .toolbar-btn:hover {
        background: var(--bg-color);
    }

    .toolbar-btn.active {
        background: var(--accent-color);
        color: var(--bg-color);
    }

    .toolbar-btn-upload {
        background: var(--accent-color);
        color: white;
    }

    .toolbar-btn-upload:hover {
        filter: brightness(1.1);
        background: var(--accent-color);
    }

    .toolbar-icon {
        font-weight: 700;
    }

    .toolbar-icon.italic {
        font-style: italic;
    }

    .code-block-icon {
        font-family: monospace;
        font-size: 0.8rem;
    }

    .editor-content {
        display: flex;
        flex: 1;
        min-height: 400px;
    }

    .split-view .editor-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }

    .preview-only .editor-content {
        display: block;
    }

    .editor-pane {
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
    }

    .editor-textarea {
        flex: 1;
        padding: 1rem;
        border: none;
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        resize: none;
        outline: none;
    }

    .editor-textarea::placeholder {
        color: var(--text-muted);
    }

    .preview-pane {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .preview-pane.full-width {
        width: 100%;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .preview-header .btn-link {
        text-transform: none;
        letter-spacing: normal;
        font-size: 0.85rem;
        padding: 0;
        background: none;
        border: none;
        color: var(--accent-color);
        cursor: pointer;
    }

    .preview-header .btn-link:hover {
        text-decoration: underline;
    }

    .preview-content {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        background: var(--bg-color);
    }

    /* Markdown rendered content styles */
    .markdown-body {
        color: var(--text-color);
        line-height: 1.7;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
        line-height: 1.3;
        color: var(--text-color);
    }

    .markdown-body h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    .markdown-body h3 { font-size: 1.25em; }
    .markdown-body h4 { font-size: 1em; }

    .markdown-body p {
        margin-top: 0;
        margin-bottom: 1em;
    }

    .markdown-body a {
        color: var(--accent-color);
        text-decoration: none;
    }

    .markdown-body a:hover {
        text-decoration: underline;
    }

    .markdown-body code {
        background: var(--bg-secondary);
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
    }

    .markdown-body pre {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
        margin: 1em 0;
    }

    .markdown-body pre code {
        background: none;
        padding: 0;
        font-size: 0.9em;
        line-height: 1.5;
    }

    .markdown-body blockquote {
        margin: 1em 0;
        padding: 0.5em 1em;
        border-left: 4px solid var(--accent-color);
        background: var(--bg-secondary);
        color: var(--text-muted);
    }

    .markdown-body blockquote p:last-child {
        margin-bottom: 0;
    }

    .markdown-body ul,
    .markdown-body ol {
        margin: 1em 0;
        padding-left: 2em;
    }

    .markdown-body li {
        margin: 0.25em 0;
    }

    .markdown-body img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }

    .markdown-body hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 2em 0;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
    }

    .markdown-body th,
    .markdown-body td {
        border: 1px solid var(--border-color);
        padding: 0.5em 1em;
        text-align: left;
    }

    .markdown-body th {
        background: var(--bg-secondary);
        font-weight: 600;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .split-view .editor-content {
            grid-template-columns: 1fr;
        }

        .editor-pane {
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            min-height: 200px;
        }

        .preview-pane {
            min-height: 200px;
        }
    }
</style>

@code {
    private static readonly MarkdownPipeline Pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    /// <summary>
    /// Gets or sets the markdown content value.
    /// </summary>
    [Parameter]
    public string Value { get; set; } = string.Empty;

    /// <summary>
    /// Event callback when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the placeholder text.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "Write your content in Markdown...";

    /// <summary>
    /// Gets or sets whether the editor is in preview-only mode.
    /// </summary>
    [Parameter]
    public bool IsPreviewOnly { get; set; }

    /// <summary>
    /// Event callback when preview mode changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsPreviewOnlyChanged { get; set; }

    /// <summary>
    /// Gets or sets the post slug for image uploads.
    /// When provided, the image upload button will be shown.
    /// </summary>
    [Parameter]
    public string? PostSlug { get; set; }

    private string TextAreaId { get; } = $"markdown-editor-{Guid.NewGuid():N}";

    private string PreviewPaneId { get; } = $"markdown-preview-{Guid.NewGuid():N}";

    private string RenderedHtml => RenderMarkdown(Value);

    private bool showImageUploadDialog;

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrWhiteSpace(markdown))
        {
            return "<p class=\"preview-placeholder\">Start typing to see preview...</p>";
        }

        try
        {
            return Markdown.ToHtml(markdown, Pipeline);
        }
        catch
        {
            return "<p class=\"preview-error\">Error rendering preview</p>";
        }
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await HighlightCodeBlocksAsync();
    }

    private async Task HighlightCodeBlocksAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("markdownEditor.highlightCode", PreviewPaneId);
        }
        catch
        {
            // Ignore JS interop errors during pre-rendering or when Prism is not loaded
        }
    }

    private async Task OnValueChanged(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? string.Empty;
        await ValueChanged.InvokeAsync(Value);
    }

    private async Task TogglePreview()
    {
        IsPreviewOnly = !IsPreviewOnly;
        await IsPreviewOnlyChanged.InvokeAsync(IsPreviewOnly);
    }

    private void OpenImageUploadDialog()
    {
        showImageUploadDialog = true;
    }

    private void CloseImageUploadDialog()
    {
        showImageUploadDialog = false;
    }

    private async Task HandleImageInserted(string markdown)
    {
        // Insert the markdown at the current cursor position
        var result = await JS.InvokeAsync<TextSelection>("markdownEditor.getSelection", TextAreaId);

        var newValue = Value[..result.Start] + markdown + Value[result.End..];
        Value = newValue;
        await ValueChanged.InvokeAsync(Value);

        // Set cursor position after insert
        var newCursorPos = result.Start + markdown.Length;
        await JS.InvokeVoidAsync("markdownEditor.setSelection", TextAreaId, newCursorPos, newCursorPos);

        showImageUploadDialog = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (!e.CtrlKey && !e.MetaKey)
        {
            return;
        }

        FormattingType? formatting = null;

        if (e.ShiftKey)
        {
            formatting = e.Key.ToLowerInvariant() switch
            {
                "i" => FormattingType.Image,
                "`" => FormattingType.CodeBlock,
                _ => null,
            };
        }
        else
        {
            formatting = e.Key.ToLowerInvariant() switch
            {
                "b" => FormattingType.Bold,
                "i" => FormattingType.Italic,
                "1" => FormattingType.H1,
                "2" => FormattingType.H2,
                "3" => FormattingType.H3,
                "k" => FormattingType.Link,
                "`" => FormattingType.InlineCode,
                "q" => FormattingType.Quote,
                "u" => FormattingType.BulletList,
                "o" => FormattingType.NumberedList,
                _ => null,
            };
        }

        if (formatting.HasValue)
        {
            await InsertFormatting(formatting.Value);
        }
    }

    private async Task InsertFormatting(FormattingType type)
    {
        var result = await JS.InvokeAsync<TextSelection>("markdownEditor.getSelection", TextAreaId);

        var (prefix, suffix, placeholder) = type switch
        {
            FormattingType.Bold => ("**", "**", "bold text"),
            FormattingType.Italic => ("*", "*", "italic text"),
            FormattingType.H1 => ("# ", "", "Heading 1"),
            FormattingType.H2 => ("## ", "", "Heading 2"),
            FormattingType.H3 => ("### ", "", "Heading 3"),
            FormattingType.Link => ("[", "](url)", "link text"),
            FormattingType.Image => ("![", "](image-url)", "alt text"),
            FormattingType.InlineCode => ("`", "`", "code"),
            FormattingType.CodeBlock => ("```\n", "\n```", "code block"),
            FormattingType.Quote => ("> ", "", "quote"),
            FormattingType.BulletList => ("- ", "", "list item"),
            FormattingType.NumberedList => ("1. ", "", "list item"),
            _ => ("", "", ""),
        };

        var selectedText = result.SelectedText;
        var textToInsert = string.IsNullOrEmpty(selectedText) ? placeholder : selectedText;

        var newValue = Value[..result.Start] + prefix + textToInsert + suffix + Value[result.End..];

        Value = newValue;
        await ValueChanged.InvokeAsync(Value);

        // Set cursor position after insert
        var newCursorPos = result.Start + prefix.Length + textToInsert.Length;
        await JS.InvokeVoidAsync("markdownEditor.setSelection", TextAreaId, newCursorPos, newCursorPos);
    }

    private enum FormattingType
    {
        Bold,
        Italic,
        H1,
        H2,
        H3,
        Link,
        Image,
        InlineCode,
        CodeBlock,
        Quote,
        BulletList,
        NumberedList,
    }

    private record TextSelection(int Start, int End, string SelectedText);
}
